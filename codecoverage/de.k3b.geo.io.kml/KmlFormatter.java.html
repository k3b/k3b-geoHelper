<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KmlFormatter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">k3b-geoHelper</a> &gt; <a href="index.source.html" class="el_package">de.k3b.geo.io.kml</a> &gt; <span class="el_source">KmlFormatter.java</span></div><h1>KmlFormatter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2015-2021 by k3b.
 *
 * This file is part of k3b-geoHelper library.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package de.k3b.geo.io.kml;

import org.apache.commons.io.FilenameUtils;

import java.io.Closeable;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.List;
import java.util.Locale;

import de.k3b.geo.api.GeoPointDto;
import de.k3b.geo.api.IGeoPointInfo;
import de.k3b.geo.io.GeoFormatter;
import de.k3b.geo.io.GeoUriDef;
import de.k3b.util.XmlUtil;

/** convert List&lt;IGeoPointInfo&gt; to kml file format */
public class KmlFormatter implements Closeable {
    private static final String HEADER = &quot;&lt;?xml version='1.0' encoding='UTF-8'?&gt;\n&quot; +
            &quot;&lt;kml xmlns='http://www.opengis.net/kml/2.2'\n&quot; +
            &quot;\txmlns:atom='http://www.w3.org/2005/Atom'\n&quot; +
            &quot;\txmlns:gx='http://www.google.com/kml/ext/2.2'\n&quot; +
            &quot;\txmlns:k3b='uri:https://github.com/k3b/k3b-geoHelper/' &gt;\n&quot; +
            &quot;\t&lt;Document&gt;&quot;;
    private static final String FOOTER = &quot;\t&lt;/Document&gt;\n&quot; +
            &quot;&lt;/kml&gt;&quot;;
    private static final String SYMBOL_HEADER = &quot;\t\t&lt;Style id='default'&gt;&quot;;
    private static final String SYMBOL_FOOTER = &quot;\t\t&lt;/Style&gt;\n&quot;;
    private static final String IDENT3 = &quot;\t\t\t&quot;;
    private final PrintWriter printWriter;

<span class="fc" id="L49">    private boolean created = false;</span>
<span class="fc" id="L50">    private boolean symbolCreated = false;</span>

    public static void export(List&lt;IGeoPointInfo&gt; geoInfos, PrintWriter printWriter) throws IOException {
<span class="fc" id="L53">        KmlFormatter exporter = null;</span>
        try {
<span class="fc" id="L55">            exporter = new KmlFormatter(printWriter);</span>

<span class="fc bfc" id="L57" title="All 2 branches covered.">            for (IGeoPointInfo geoInfo : geoInfos) {</span>
<span class="fc" id="L58">                exporter.writeSymbolDefinition(geoInfo);</span>
<span class="fc" id="L59">            }</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">            for (IGeoPointInfo geoInfo : geoInfos) {</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">                if (!GeoPointDto.isEmpty(geoInfo)) {</span>
<span class="fc" id="L62">                    exporter.writeGeoInformation(geoInfo);</span>
                }
<span class="fc" id="L64">            }</span>
        } finally {
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">            if (exporter != null) {</span>
<span class="fc" id="L67">                exporter.close();</span>
            }
        }
<span class="fc" id="L70">    }</span>

<span class="fc" id="L72">    private KmlFormatter(PrintWriter printWriter) {</span>
<span class="fc" id="L73">        this.printWriter = printWriter;</span>
<span class="fc" id="L74">    }</span>

    private void writeSymbolDefinition(IGeoPointInfo geoInfo) {
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        String symbol = geoInfo != null ? geoInfo.getSymbol() : null;</span>
<span class="pc bpc" id="L78" title="1 of 4 branches missed.">        if (symbol != null &amp;&amp; symbol.length() &gt; 0) {</span>
<span class="fc" id="L79">            writeSymbolHeaderIfNecessary();</span>

<span class="fc" id="L81">            String baseName = getSymbolname(symbol);</span>
<span class="fc" id="L82">            pr(IDENT3 + &quot;&lt;IconStyle id='&quot; + baseName +&quot;'&gt;&lt;Icon&gt;&lt;href&gt;&quot; + XmlUtil.escapeXMLElement(symbol) +</span>
                    &quot;&lt;/href&gt;&lt;/Icon&gt;&lt;/IconStyle&gt;&quot;);
        }
<span class="fc" id="L85">    }</span>

    private String getSymbolname(String symbol) {
<span class="fc" id="L88">        return XmlUtil.escapeXmlAttribute(FilenameUtils.getBaseName(symbol));</span>
    }

    private void writeGeoInformation(IGeoPointInfo geoInfo) {
<span class="fc bfc" id="L92" title="All 2 branches covered.">        if (symbolCreated) {</span>
<span class="fc" id="L93">            pr(SYMBOL_FOOTER);</span>
<span class="fc" id="L94">            symbolCreated = false;</span>
        }
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (geoInfo != null) {</span>
<span class="fc" id="L97">            writeHeaderIfNecessary();</span>
<span class="fc" id="L98">            pr(&quot;\t\t&lt;Placemark&gt;&quot;);</span>

<span class="fc" id="L100">            pr(&quot;description&quot;, geoInfo.getDescription());</span>
<span class="fc" id="L101">            pr(&quot;name&quot;, geoInfo.getName());</span>

<span class="fc" id="L103">            pr(&quot;k3b:&quot; + GeoUriDef.ID, geoInfo.getId());</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">            if (geoInfo.getSymbol() != null) {</span>
<span class="fc" id="L105">                pr(&quot;styleUrl&quot;, &quot;#&quot; + getSymbolname(geoInfo.getSymbol()));</span>
            }

<span class="fc bfc" id="L108" title="All 2 branches covered.">            if (geoInfo.getLink() != null) {</span>
<span class="fc" id="L109">                pr(IDENT3 + &quot;&lt;atom:link href='&quot; + XmlUtil.escapeXmlAttribute(geoInfo.getLink()) +&quot;' /&gt;&quot;);</span>
            }

<span class="pc bpc" id="L112" title="1 of 2 branches missed.">            boolean hasGeo = !GeoPointDto.isEmpty(geoInfo);</span>
<span class="pc bpc" id="L113" title="3 of 4 branches missed.">            if (hasGeo || geoInfo.getTimeOfMeasurement() != null) {</span>
<span class="fc" id="L114">                pr(IDENT3 + &quot;&lt;Point&gt;&quot;);</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">                if (hasGeo) {</span>
                    // note KmlDef_22.COORDINATES use lon,lat reverse order
<span class="fc" id="L117">                    pr(String.format(Locale.US, IDENT3 + &quot;\t&lt;coordinates&gt;%f,%f&lt;/coordinates&gt;&quot;,</span>
<span class="fc" id="L118">                            geoInfo.getLongitude(), geoInfo.getLatitude()));</span>
                }
<span class="fc bfc" id="L120" title="All 2 branches covered.">                if (geoInfo.getTimeOfMeasurement() != null) {</span>
<span class="fc" id="L121">                    pr(IDENT3 + &quot;\t&lt;when&gt;&quot; + XmlUtil.escapeXMLElement(GeoFormatter.formatDate(geoInfo.getTimeOfMeasurement())) + &quot;&lt;/when&gt;&quot;);</span>
                }
<span class="fc" id="L123">                pr(IDENT3 + &quot;&lt;/Point&gt;&quot;);</span>
            }
<span class="fc bfc" id="L125" title="All 2 branches covered.">            if (geoInfo.getZoomMin() &gt; 0) {</span>
<span class="fc" id="L126">                pr(&quot;k3b:&quot;+ GeoUriDef.ZOOM, &quot;&quot; + geoInfo.getZoomMin());</span>
            }
<span class="fc bfc" id="L128" title="All 2 branches covered.">            if (geoInfo.getZoomMax() &gt; 0) {</span>
<span class="fc" id="L129">                pr(&quot;k3b:&quot;+ GeoUriDef.ZOOM_MAX, &quot;&quot; + geoInfo.getZoomMax());</span>
            }

<span class="fc" id="L132">            pr(&quot;\t\t&lt;/Placemark&gt;&quot;);</span>
        }
<span class="fc" id="L134">    }</span>

    private void writeHeaderIfNecessary() {
<span class="fc bfc" id="L137" title="All 2 branches covered.">        if (!created) {</span>
<span class="fc" id="L138">            created = true;</span>
<span class="fc" id="L139">            pr(HEADER);</span>
        }
<span class="fc" id="L141">    }</span>

    private void writeSymbolHeaderIfNecessary() {
<span class="fc" id="L144">        writeHeaderIfNecessary();</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (!symbolCreated) {</span>
<span class="fc" id="L146">            symbolCreated = true;</span>
<span class="fc" id="L147">            pr(SYMBOL_HEADER);</span>
        }
<span class="fc" id="L149">    }</span>

    private void pr(String tag, String value) {
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (notEmpty(value)) {</span>
<span class="fc" id="L153">            pr(IDENT3 +</span>
                    &quot;&lt;&quot; + tag +&quot;&gt;&quot; +
<span class="fc" id="L155">                    XmlUtil.escapeXMLElement(value) +</span>
                    &quot;&lt;/&quot; + tag +&quot;&gt;&quot;);
        }
<span class="fc" id="L158">    }</span>

    private boolean notEmpty(String value) {
<span class="pc bpc" id="L161" title="1 of 4 branches missed.">        return value != null &amp;&amp; value.length() &gt; 0;</span>
    }

    protected void pr(String xml) {
<span class="fc" id="L165">        printWriter.println(xml);</span>
<span class="fc" id="L166">    }</span>

    @Override
    public void close() throws IOException {
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        if (created) pr(FOOTER);</span>
<span class="fc" id="L171">        printWriter.flush();</span>
<span class="fc" id="L172">        printWriter.close();</span>
<span class="fc" id="L173">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>